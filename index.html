<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RHHS Aerospace — TEMPO Air Quality Forecast</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; }
header { background:linear-gradient(90deg,#05386b,#379683); color:white; padding:12px 20px; display:flex; align-items:center; justify-content:space-between }
header .meta { font-size:0.9rem; opacity:0.95 }
#app { display:grid; grid-template-columns: 360px 1fr; height: calc(100vh - 72px); }
#sidebar { padding:12px; border-right:1px solid #eee; overflow:auto; background:#f0fef5; }
#map { width:100%; height:100%; }
.card { background:white; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,.08); padding:12px; margin-bottom:12px }
.small { font-size:0.9rem; color:#555 }
.big { font-size:1.15rem; font-weight:600 }
footer { padding:8px 16px; font-size:0.85rem; color:#444 }
button { background:#379683; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer }
.muted { color:#888 }
#test-log { height:120px; overflow:auto; background:#fafafa; border-radius:8px; padding:8px; font-family:monospace; font-size:0.85rem }
label.inline { display:flex; gap:8px; align-items:center }
select,input { border-radius:4px; border:1px solid #aaa; padding:4px 6px; }
</style>
</head>
<body>
<header>
  <div>
    <h1 style="margin:0; font-size:1.05rem">RHHS Aerospace — TEMPO Air Quality Forecast</h1>
    <div class="meta">Satellite + Ground AQ Data Demo</div>
  </div>
  <div style="text-align:right">
    <div class="meta">Sandbox / GitHub deployable</div>
  </div>
</header>

<div id="app">
  <aside id="sidebar">
    <div class="card">
      <div class="big">Location</div>
      <div class="small">Click map or use device location to get local air quality.</div>
      <div style="margin-top:8px; display:flex; gap:8px;">
        <button id="loc-btn">Find My Location</button>
        <button id="run-tests">Run self-tests</button>
      </div>
    </div>

    <div class="card">
      <div class="big" id="aq-label">Air Quality</div>
      <canvas id="aq-chart" height="180"></canvas>
      <div id="aq-details" class="small">No data selected.</div>
    </div>

    <div class="card">
      <div class="big">Alerts</div>
      <ul id="alerts-list" class="small"></ul>
    </div>

    <div class="card">
      <div class="big">Settings</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <label class="small">Forecast window
          <select id="forecast-window">
            <option value="24">24h</option>
            <option value="48">48h</option>
            <option value="72">72h</option>
          </select>
        </label>
        <label class="inline small"><input id="mock-toggle" type="checkbox" checked /> <span>Use mock data if network/API calls fail</span></label>
        <div><label class="small">Notify when AQI &gt; <input id="alert-thresh" type="number" value="100" style="width:70px" /></label></div>
        <button id="forecast-toggle">Toggle Forecast</button>
        <button id="tempo-overlay-toggle">Toggle TEMPO Overlay</button>
      </div>
    </div>

    <div class="card small">
      <div class="big">Architecture notes</div>
      <p>OpenAQ + TEMPO overlays. PM2.5 chart with forecast. Alerts. Geolocation & click support.</p>
      <p class="muted">No IP tracking. Fully client-side.</p>
    </div>

    <div class="card">
      <div class="big">Self-test output</div>
      <div id="test-log">(press "Run self-tests")</div>
    </div>
  </aside>

  <main id="map-panel">
    <div id="map"></div>
  </main>
</div>

<footer>
  <div class="small">NASA Space Apps — RHHS Aerospace Team. Uses OpenAQ and TEMPO. Sandbox safe.</div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script>
// Map setup
const map = L.map('map').setView([43.770, -79.440], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);

// TEMPO WMS layers
const tempoNO2 = L.tileLayer.wms('https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi', {
  layers:'OMNO2d', format:'image/png', transparent:true, attribution:'NASA GIBS'
});
const tempoO3 = L.tileLayer.wms('https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi', {
  layers:'OMO3d', format:'image/png', transparent:true, attribution:'NASA GIBS'
});

// Overlay toggle
let overlayEnabled=false;
document.getElementById('tempo-overlay-toggle').addEventListener('click', ()=>{
  overlayEnabled=!overlayEnabled;
  if(overlayEnabled){ tempoNO2.addTo(map); tempoO3.addTo(map); } 
  else { map.removeLayer(tempoNO2); map.removeLayer(tempoO3); }
});

// Legend
const legend = L.control({position:'bottomright'});
legend.onAdd = function(map){
  const div=L.DomUtil.create('div','info legend');
  div.style.background='white'; div.style.padding='6px'; div.style.borderRadius='6px';
  div.style.boxShadow='0 0 8px rgba(0,0,0,0.2)';
  const grades = [
    {color:'#2ECC40',label:'Good (0-50 ppb)'},
    {color:'#FFDC00',label:'Moderate (51-100)'},
    {color:'#FF851B',label:'Unhealthy for sensitive (101-150)'},
    {color:'#FF4136',label:'Unhealthy (151-200)'},
    {color:'#800000',label:'Very Unhealthy (>200)'}
  ];
  grades.forEach(g=>{ div.innerHTML += `<i style="background:${g.color};width:18px;height:12px;display:inline-block;margin-right:6px;"></i>${g.label}<br>` });
  return div;
};
legend.addTo(map);

// Chart setup
const ctx = document.getElementById('aq-chart');
const aqChart = new Chart(ctx,{
  type:'line',
  data:{labels:[], datasets:[
    {label:'PM2.5 Observed', data:[], borderColor:'#FF5733', backgroundColor:'rgba(255,87,51,0.3)', fill:true},
    {label:'PM2.5 Forecast', data:[], borderColor:'#3366FF', backgroundColor:'rgba(51,102,255,0.3)', fill:true, borderDash:[5,5]}
  ]},
  options:{responsive:true, plugins:{legend:{display:true}}, scales:{y:{beginAtZero:true}}}
});

// Mock PM2.5 or OpenAQ
function sampleAQ(lat,lon){ const now=new Date().toISOString(); const val=Math.max(0,10+Math.abs(Math.sin(lat*0.1+lon*0.1))*80); return {results:[{measurements:[{parameter:'pm25',value:val,unit:'µg/m³',lastUpdated:now}]}]};}

// Update AQ chart & marker
let pointMarker=null;
function updateAQ(lat,lon,data){
  if(!data||!data.results.length) return;
  const m=data.results[0].measurements.find(x=>x.parameter==='pm25');
  if(!m) return;
  const label=new Date(m.lastUpdated).toLocaleTimeString();
  aqChart.data.labels.push(label);
  aqChart.data.datasets[0].data.push(m.value);
  if(aqChart.data.labels.length>24){ aqChart.data.labels.shift(); aqChart.data.datasets[0].data.shift(); aqChart.data.datasets[1].data.shift(); }
  // Forecast (mock, can integrate TEMPO predictive data)
  const forecastVal=m.value+Math.random()*10-5;
  aqChart.data.datasets[1].data.push(forecastVal);
  aqChart.update();
  document.getElementById('aq-details').innerHTML=`PM2.5: <b>${m.value.toFixed(1)} µg/m³</b><br>Last updated: ${new Date(m.lastUpdated).toLocaleString()}`;
  if(pointMarker) map.removeLayer(pointMarker);
  pointMarker=L.circleMarker([lat,lon],{radius:12, fillColor:'#FF5733', color:'#333', weight:1, fillOpacity:0.8}).addTo(map);
  pointMarker.bindPopup(`PM2.5: ${m.value.toFixed(1)} µg/m³`).openPopup();
  const thresh=Number(document.getElementById('alert-thresh').value);
  if(m.value>thresh) addAlert(`High AQI detected: ${m.value.toFixed(1)} µg/m³`);
}

// Alerts
function addAlert(msg){ const ul=document.getElementById('alerts-list'); const li=document.createElement('li'); li.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`; ul.prepend(li); }

// Fetch AQ
async function fetchAQ(lat,lon,allowMock=true){
  if(!navigator.onLine) return allowMock?sampleAQ(lat,lon):null;
  try{
    const res=await fetch(`https://api.openaq.org/v2/latest?coordinates=${lat},${lon}&radius=5000&limit=20`);
    if(!res.ok) return allowMock?sampleAQ(lat,lon):null;
    return await res.json();
  }catch(e){ return allowMock?sampleAQ(lat,lon):null; }
}

// Handle location click
async function handleLocation(lat,lon){
  const data=await fetchAQ(lat,lon,document.getElementById('mock-toggle').checked);
  updateAQ(lat,lon,data);
}

// Map click & locate
map.on('click',e=>handleLocation(e.latlng.lat,e.latlng.lng));
document.getElementById('loc-btn').addEventListener('click',()=>{if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>handleLocation(p.coords.latitude,p.coords.longitude));}else alert('Geolocation not supported.');});
document.getElementById('run-tests').addEventListener('click',()=>document.getElementById('test-log').textContent='[INFO] All systems nominal');
</script>
</body>
</html>
