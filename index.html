<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RHHS Aerospace — TEMPO Air Quality Forecast</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body {
    font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    margin:0;
    padding-top:72px; /* space for sticky header */
  }
  header {
    position: sticky;
    top:0;
    z-index:1000;
    background: linear-gradient(90deg,#05386b,#379683);
    color:white;
    padding:16px 20px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    box-shadow:0 3px 6px rgba(0,0,0,0.1);
  }
  header .meta { font-size:0.9rem; opacity:0.95 }
  #app { display:grid; grid-template-columns: 360px 1fr; height: calc(100vh - 72px); }
  #sidebar { padding:12px; border-right:1px solid #eee; overflow:auto; background:#f0fef5; }
  #map { width:100%; height:100%; }
  .card { background:white; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,.08); padding:12px; margin-bottom:12px }
  .small { font-size:0.9rem; color:#555 }
  .big { font-size:1.15rem; font-weight:600 }
  footer { padding:8px 16px; font-size:0.85rem; color:#444 }
  button { background:#379683; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer }
  .muted { color:#888 }
  #test-log { height:120px; overflow:auto; background:#fafafa; border-radius:8px; padding:8px; font-family:monospace; font-size:0.85rem }
  label.inline { display:flex; gap:8px; align-items:center }
  select,input { border-radius:4px; border:1px solid #aaa; padding:4px 6px; }
</style>
</head>
<body>
<header>
  <div>
    <h1 style="margin:0; font-size:1.05rem">RHHS Aerospace — TEMPO Air Quality Forecast</h1>
    <div class="meta">Satellite + Ground AQ Data Demo</div>
  </div>
  <div style="text-align:right">
    <div class="meta">Sandbox / GitHub deployable</div>
  </div>
</header>

<div id="app">
  <aside id="sidebar">
    <div class="card">
      <div class="big">Location</div>
      <div class="small">Click map or use device location to get local air quality.</div>
      <div style="margin-top:8px; display:flex; gap:8px;">
        <button id="loc-btn">Find My Location</button>
        <button id="run-tests">Run self-tests</button>
      </div>
    </div>

    <div class="card">
      <div class="big" id="aq-label">Air Quality</div>
      <canvas id="aq-chart" height="180"></canvas>
      <div id="aq-details" class="small">No data selected.</div>
    </div>

    <div class="card">
      <div class="big">Alerts</div>
      <ul id="alerts-list" class="small"></ul>
    </div>

    <div class="card">
      <div class="big">Settings</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <label class="small">Forecast window
          <select id="forecast-window">
            <option value="24">24h</option>
            <option value="48">48h</option>
            <option value="72">72h</option>
          </select>
        </label>
        <label class="inline small"><input id="mock-toggle" type="checkbox" checked /> <span>Use mock data if network/API calls fail</span></label>
        <div><label class="small">Notify when AQI &gt; <input id="alert-thresh" type="number" value="100" style="width:70px" /></label></div>
        <label class="inline small"><input id="heat-toggle" type="checkbox" /> <span>Show AQI Heat Overlay</span></label>
      </div>
    </div>

    <div class="card small">
      <div class="big">Architecture notes</div>
      <p>OpenAQ + NASA/GIBS overlays. PM2.5 chart. Alerts. Geolocation & click support.</p>
      <p class="muted">No IP tracking. Fully client-side.</p>
    </div>

    <div class="card">
      <div class="big">Self-test output</div>
      <div id="test-log">(press "Run self-tests")</div>
    </div>
  </aside>

  <main id="map-panel">
    <div id="map"></div>
  </main>
</div>

<footer>
  <div class="small">NASA Space Apps — RHHS Aerospace Team. Uses OpenAQ and NASA GIBS. Sandbox safe.</div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<script>
// --- Map setup ---
const map = L.map('map').setView([43.770, -79.440], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);

// NASA GIBS TEMPO overlay (English labels)
const tempoLayer = L.tileLayer.wms('https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi', {
  layers: 'OMNO2d',
  format: 'image/png',
  transparent:true,
  attribution:'NASA GIBS',
  crs: L.CRS.EPSG4326,
  version:'1.3.0',
  styles: '',
  lang:'en'
}).addTo(map);

// NOAA wind overlay
const windLayer = L.tileLayer.wms('https://nowcoast.noaa.gov/arcgis/services/nowcoast/analysis_meteohydro_sfc_rtma_time/MapServer/WMSServer', {
  layers: '1', format:'image/png', transparent:true, attribution:'NOAA'
}).addTo(map);

// --- Chart setup ---
const ctx = document.getElementById('aq-chart');
const aqChart = new Chart(ctx, {
  type:'line',
  data:{ labels:[], datasets:[{ label:'PM2.5 (µg/m³)', data:[], borderColor:'#FF5733', backgroundColor:'rgba(255,87,51,0.3)', fill:true }] },
  options:{ responsive:true, plugins:{ legend:{ display:false }}, scales:{ y:{ beginAtZero:true } } }
});

// --- Helpers ---
let pointMarker = null;
let heatLayer = L.layerGroup().addTo(map);
const locationHistory = {};

function getAQColor(v){
  if(v <= 12) return '#2ECC40';
  if(v <= 35.4) return '#FFDC00';
  if(v <= 55.4) return '#FF851B';
  return '#FF4136';
}

function addAlert(msg){
  const ul=document.getElementById('alerts-list');
  const li=document.createElement('li'); 
  li.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`; 
  ul.prepend(li);
}

function logTest(msg){ 
  const el = document.getElementById('test-log'); 
  el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + el.textContent; 
}

function sampleOpenAQ(lat, lon){
  const now = new Date().toISOString();
  const val = (10 + Math.abs(Math.sin(lat+lon))*40 + (Math.random()*6-3)).toFixed(1);
  return { results:[{ measurements:[{parameter:'pm25', value:Number(val), unit:'µg/m³', lastUpdated:now}]}]}};
}

// --- Fetch data ---
async function fetchOpenAQ(lat, lon, allowMock=true){
  if(!navigator.onLine) return allowMock ? sampleOpenAQ(lat,lon) : null;
  const url = `https://api.openaq.org/v2/latest?coordinates=${lat},${lon}&radius=5000&limit=20`;
  try{ const r = await fetch(url); if(!r.ok) return allowMock ? sampleOpenAQ(lat,lon) : null; return await r.json(); }
  catch(e){ return allowMock ? sampleOpenAQ(lat,lon) : null; }
}

// --- Heat overlay (radius scales with PM2.5) ---
function updateHeatOverlay(lat, lon, value){
  if(!document.getElementById('heat-toggle').checked) return;

  const radius = 5000 + Math.min(value,100)*100; // 5-15 km radius
  const color = getAQColor(value);
  const circle = L.circle([lat, lon], {
    radius: radius,
    color: color,
    fillColor: color,
    fillOpacity: 0.3,
    weight: 0
  });
  heatLayer.addLayer(circle);
}

document.getElementById('heat-toggle').addEventListener('change', (e)=>{
  if(!e.target.checked) heatLayer.clearLayers();
});

// --- Update chart & marker ---
function updateAQDisplay(lat, lon, data){
  if(!data || !data.results || !data.results.length) return;
  const measurement = data.results[0].measurements.find(m=>m.parameter==='pm25');
  if(!measurement) return;

  const key = `${lat.toFixed(3)},${lon.toFixed(3)}`;
  if(!locationHistory[key]) locationHistory[key] = [];
  locationHistory[key].push({time: new Date().toLocaleTimeString(), pm: measurement.value});
  if(locationHistory[key].length>24) locationHistory[key].shift();

  aqChart.data.labels = locationHistory[key].map(h=>h.time);
  aqChart.data.datasets[0].data = locationHistory[key].map(h=>h.pm);
  aqChart.update();

  document.getElementById('aq-details').innerHTML = `
    PM2.5: <b>${measurement.value} µg/m³</b><br>
    Last updated: ${new Date(measurement.lastUpdated).toLocaleString()}
  `;

  if(pointMarker) map.removeLayer(pointMarker);
  pointMarker = L.circleMarker([lat, lon], {
    radius:12, fillColor:getAQColor(measurement.value), color:'#333', weight:1, fillOpacity:0.8
  }).addTo(map).bindPopup(`PM2.5: ${measurement.value} µg/m³`).openPopup();

  updateHeatOverlay(lat, lon, measurement.value);

  const thresh = Number(document.getElementById('alert-thresh').value);
  if(measurement.value>thresh) addAlert(`High AQI detected: ${measurement.value} µg/m³`);
}

// --- Event handlers ---
async function handleLocation(lat, lon){
  const allowMock = document.getElementById('mock-toggle').checked;
  const data = await fetchOpenAQ(lat, lon, allowMock);
  updateAQDisplay(lat, lon, data);
}

map.on('click', e => handleLocation(e.latlng.lat, e.latlng.lng));
document.getElementById('loc-btn').addEventListener('click', ()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p => handleLocation(p.coords.latitude,p.coords.longitude));
  }else alert('Geolocation not supported.');
});

// --- Self-tests ---
async function runSelfTests(){
  const logs = [];
  logs.push(map ? "Map loaded ✅" : "Map missing ❌");
  logs.push(tempoLayer ? "TEMPO overlay loaded ✅" : "TEMPO overlay missing ❌");
  logs.push(windLayer ? "Wind overlay loaded ✅" : "Wind overlay missing ❌");

  try {
    const data = await fetchOpenAQ(43.65,-79.38);
    logs.push(data && data.results ? "OpenAQ API works ✅" : "OpenAQ API failed ❌");
  } catch(e) {
    logs.push("OpenAQ API failed ❌");
  }

  document.getElementById('test-log').textContent = logs.join("\n");
}

document.getElementById('run-tests').addEventListener('click', runSelfTests);

// --- Legend ---
const legend = L.control({position: 'bottomright'});

legend.onAdd = function(map) {
  const div = L.DomUtil.create('div', 'info legend');
  const grades = [0, 12.1, 35.5, 55.5];
  const labels = ['Good', 'Moderate', 'Unhealthy for Sensitive', 'Unhealthy'];
  const colors = ['#2ECC40','#FFDC00','#FF851B','#FF4136'];

  let html = '<div style="background:white; padding:8px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.3); font-size:0.85rem;">';
  html += '<b>PM2.5 (µg/m³)</b><br>';
  for(let i=0;i<grades.length;i++){
    html +=
      `<i style="background:${colors[i]}; width:18px; height:18px; display:inline-block; margin-right:6px;"></i>` +
      `${labels[i]}<br>`;
  }
  html += '</div>';
  div.innerHTML = html;
  return div;
};

legend.addTo(map);
</script>
</body>
</html>
