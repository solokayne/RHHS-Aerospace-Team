<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RHHS Aerospace — TEMPO Air Quality Forecast</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; }
    header { background:linear-gradient(90deg,#05386b,#379683); color:white; padding:12px 20px; display:flex; align-items:center; justify-content:space-between }
    header .meta { font-size:0.9rem; opacity:0.95 }
    #app { display:grid; grid-template-columns: 360px 1fr; height: calc(100vh - 72px); }
    #sidebar { padding:12px; border-right:1px solid #eee; overflow:auto; background:#f0fef5; }
    #map { width:100%; height:100%; }
    .card { background:white; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,.08); padding:12px; margin-bottom:12px }
    .small { font-size:0.9rem; color:#555 }
    .big { font-size:1.15rem; font-weight:600 }
    footer { padding:8px 16px; font-size:0.85rem; color:#444 }
    button { background:#379683; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer }
    .muted { color:#888 }
    #test-log { height:120px; overflow:auto; background:#fafafa; border-radius:8px; padding:8px; font-family:monospace; font-size:0.85rem }
    label.inline { display:flex; gap:8px; align-items:center }
    select,input { border-radius:4px; border:1px solid #aaa; padding:4px 6px; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1 style="margin:0; font-size:1.05rem">RHHS Aerospace — TEMPO Air Quality Forecast</h1>
      <div class="meta">Demo with resilient fetch, charts, and overlays</div>
    </div>
    <div style="text-align:right">
      <div class="meta">Sandbox / GitHub deployable</div>
    </div>
  </header>

  <div id="app">
    <aside id="sidebar">

      <div class="card">
        <div class="big">Location</div>
        <div class="small">Click anywhere on the map to get local air quality, or use your device location.</div>
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="loc-btn">Find My Location</button>
          <button id="run-tests">Run self-tests</button>
        </div>
      </div>

      <div class="card">
        <div class="big" id="aq-label">Air Quality</div>
        <canvas id="aq-chart" height="180"></canvas>
        <div id="aq-details" class="small">No data selected.</div>
      </div>

      <div class="card">
        <div class="big">Alerts</div>
        <ul id="alerts-list" class="small"></ul>
      </div>

      <div class="card">
        <div class="big">Settings</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <label class="small">Forecast window
            <select id="forecast-window">
              <option value="24">24h</option>
              <option value="48">48h</option>
              <option value="72">72h</option>
            </select>
          </label>
          <label class="inline small"><input id="mock-toggle" type="checkbox" checked /> <span>Use mock data if network/API calls fail</span></label>
          <div><label class="small">Notify when AQI &gt; <input id="alert-thresh" type="number" value="100" style="width:70px" /></label></div>
        </div>
      </div>

      <div class="card small">
        <div class="big">Architecture notes</div>
        <p>Fetches OpenAQ + weather. TEMPO overlay fallback. Chart shows PM2.5. Mock data used if APIs fail.</p>
        <p class="muted">No IP-based tracking. Fully browser geolocation compliant.</p>
      </div>

      <div class="card">
        <div class="big">Self-test output</div>
        <div id="test-log">(press "Run self-tests")</div>
      </div>

    </aside>

    <main id="map-panel">
      <div id="map"></div>
    </main>
  </div>

  <footer>
    <div class="small">Prototype for NASA Space Apps — RHHS Aerospace Team. Uses OpenAQ and NASA data. Sandbox safe.</div>
  </footer>

  <!-- External libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <script>
const map = L.map('map').setView([43.770, -79.440], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);

let tempoLayer = L.layerGroup().addTo(map);
let pointMarker = null;

const ctx = document.getElementById('aq-chart');
const aqChart = new Chart(ctx, {
  type:'line',
  data:{ labels:[], datasets:[{ label:'PM2.5 (µg/m³)', data:[], borderColor:'#FF5733', backgroundColor:'rgba(255,87,51,0.3)', fill:true }] },
  options:{ responsive:true, plugins:{ legend:{ display:false }}, scales:{ y:{ beginAtZero:true } } }
});

function logTest(msg){ 
  const el = document.getElementById('test-log'); 
  el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + el.textContent; 
}

function sampleOpenAQ(lat, lon){
  const now = new Date().toISOString();
  const val = (10 + Math.abs(Math.sin(lat+lon))*40 + (Math.random()*6-3)).toFixed(1);
  return { results:[{ measurements:[{parameter:'pm25', value:Number(val), unit:'µg/m³', lastUpdated:now}]}]};
}

function getAQColor(v){
  if(v <= 12) return '#2ECC40';
  if(v <= 35.4) return '#FFDC00';
  if(v <= 55.4) return '#FF851B';
  return '#FF4136';
}

function createMockTempoOverlay(lat, lon){
  tempoLayer.clearLayers();
  const grid = L.layerGroup();
  const step = 0.05;
  for(let dx=-0.2; dx<=0.2; dx+=step){
    for(let dy=-0.2; dy<=0.2; dy+=step){
      const cellLat=lat+dx, cellLon=lon+dy;
      const dist=Math.sqrt(dx*dx+dy*dy);
      const base=Math.max(5, 60-dist*150+(lat+lon)%15);
      const value=Math.round(base+(Math.random()-0.5)*10);
      const circle=L.circle([cellLat,cellLon], {radius:5000, fillColor:getAQColor(value), fillOpacity:0.45, stroke:false});
      circle.bindTooltip(`PM2.5 ≈ ${value} µg/m³`);
      grid.addLayer(circle);
    }
  }
  tempoLayer.addLayer(grid);
}

async function fetchOpenAQ(lat, lon, allowMock=true){
  if(!navigator.onLine) return allowMock ? sampleOpenAQ(lat,lon) : null;
  const url=`https://api.openaq.org/v2/latest?coordinates=${lat},${lon}&radius=5000&limit=20`;
  try{ const r=await fetch(url); if(!r.ok) return allowMock ? sampleOpenAQ(lat,lon) : null; return await r.json(); }
  catch(e){ return allowMock ? sampleOpenAQ(lat,lon) : null; }
}

function addAlert(msg){
  const ul=document.getElementById('alerts-list');
  const li=document.createElement('li'); 
  li.text
